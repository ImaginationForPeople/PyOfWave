Using PyOfWave's Core module
****************************

pyofwave_server.core provides facilities that are shared, in various methods, by all protocols and extensions. Specifics for extending this are provided by :doc:`Authentication`, :doc:`DataStorage`, :doc:`Operations`, and :doc:`Protocols`.

core.datasource
===============

.. uml::
   interface DataSource
   object PREFERENCES.STORAGE_OBJECT
   object PREFERENCES.CACHE_OBJECT
   object PREFERENCES.FEDERATION_OBJECT

   zope.interface.Interface ..|> DataSource

   DataSource <|.. PREFERENCES.STORAGE_OBJECT

   DataSource : newDocument()
   DataSource : getDocument(string url)
   DataSource : getDocumentVersion(string url, int start, int end, int limit)
   DataSource : searchDocuments(string user, string search)
   DataSource : setTags(string doc, string user, string[] **tags)

The interface DataSource provides access to persistant XML following the wave schema. LXML is used to represent the XML files.

.. py:method:: newDocument()

   Creates a new document in the DataSource. Returns the 
   blank :py:class:`lxml.etree.ElementBase` object if successful. 

.. py:method:: getDocument(url)

   Loads the document from the DataSource. Returns a :py:class:`lxml.etree.ElementBase` object. 

.. py:method:: getDocumentVersion(url, start, end, limit)

   Loads the document at the specified times. Returns a iterable of :py:class:`lxml.etree.ElementBase` objects. 

.. py:method:: searchDocuments(user, search)

   Returns a list of wave URLs to documents that match the source. The tags that may be 
   specified in the search are provided by :py:meth:`setTags`. 

.. py:method:: setTags(doc, user, **tags)

   Sets the tags for the documentation for use by search. 

core.delta
==========

.. uml::
   object AlphaDeltaObservable
   object BetaDeltaObservable

   DeltaObservable ..|> AlphaDeltaObservable
   DeltaObservable ..|> BetaDeltaObservable

   DeltaObservable : applyDelta(lxml.etree.ElementBase doc, lxml.etree.ElementBase delta)
   DeltaObservable : addObserver(callable observer)
   DeltaObservable : removeObserver(callable observer)

:py:mod:`core.delta`, provides a classic Observer interface. This module is used to distribute changes to documents, \"deltas\", generated by the operations in the Wave Protocol. These deltas can be in either \"alpha\" or \"beta\" state (after and before being commited to storage). 

Any one has the ability to distribute deltas on a :py:class:`DeltaObservable`, but you should only do it on :py:data:`BetaDeltaObservable` leaving :py:class:`DataSource` objects to distribute on :py:data:`AlphaDeltaObservable`, so as that the Deltas distributed there are truly in alpha state.

DeltaObservable
---------------

:py:class:`DeltaObservable` distributes :py:class:`Delta` objects throughout all extensions. 

.. py:class:: pyofwave_server.core.delta.DeltaObservable

  Distributes deltas between different components of PyOfWave server.

  .. py:method:: applyDelta(doc, delta)

    Notifies all observers that doc has/will (depending on object) had the changes in delta applied. 

    Delta is a partial LXML tree with :py:data:`delete` properties marking elements to remove.

  .. py:method:: addObserver(observer, url = "")

    Calls *observer* when :py:meth:`applyDelta` is called, passing the same arguments.

  .. py:method:: removeObserver(observer)

    Stops calling *observer*.

There's two instances of this class you'll use to distribute :py:class:`Delta` objects:

.. py:data:: AlphaDeltaObservable

   :py:class:`DataSource` objects pushes deltas through this 
   :py:class:`DeltaObservable`, which indicates that all :py:class:`Delta` 
   objects from this object has been commited to storage.

.. py:data:: BetaDeltaObservable

   :py:class:`DataSource` objects are observers of this object, which means 
   that by sending :py:class:`Delta` objects on this object, you are 
   commiting them to memory.

core.operation
==============

:py:mod:`core.operation` has only one function, which imports a function from pyofwave_server.operations and executes it with given arguments. 

.. py:function:: performOperation(ip, operation, kwargs)

   Executes the operation operation and provides it ip and kwargs. It will either 
   raise a :py:exc:`OperationError` providing a status dictionary and code (as in 
   HTTP Error codes), or return a mapping.

.. py:class:: Events

   Handles notification of selected events.

   .. py:method:: __init__(authzid, callback)

      Initiates an object for user identified by *authzid*, and calls *callback* to notify the caller of new events.

   .. py:method:: register(url, event)

      Starts notifying the callback when *event* happens in document identified by *url*. *event* is either an :py:class:`Operation` or a :py:class:`String`.

   .. py:method:: unregister(url, event = "*")

      Stops notifying the callback when *event* happens in document identified by *url*.

Instructions for adding operations are in :doc:`Operations`.